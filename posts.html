<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zom - المنشورات</title>
<style>
body { font-family: Arial; margin:0; background:#f0f0f0; }
header { background:#000; color:#fff; padding:10px; text-align:center; }
#postsContainer { padding:10px; }
.post { background:#fff; margin-bottom:10px; border-radius:10px; padding:10px; box-shadow:0 3px 5px rgba(0,0,0,0.2); }
button { margin:3px; cursor:pointer; }
#writePostContainer { position:fixed; bottom:10px; left:50%; transform:translateX(-50%); background:#fff; padding:10px; border-radius:10px; display:flex; gap:5px; width:90%; max-width:500px; }
#logoutBtn { position:fixed; top:10px; right:10px; padding:5px 10px; cursor:pointer; background:red; color:white; border:none; border-radius:5px; }
.commentContainer { display:none; flex-direction:column; gap:5px; margin-top:5px; }
.commentContainer input { padding:5px; border-radius:5px; border:1px solid #ccc; }
</style>
</head>
<body>

<header>Zom</header>
<button id="logoutBtn">تسجيل الخروج</button>
<main id="postsContainer"></main>

<div id="writePostContainer">
  <input type="text" id="postInput" placeholder="اكتب منشورك هنا...">
  <button id="publishBtn">نشر</button>
</div>

<script type="module">
import { db } from './firebase-config.js';
import { ref, push, onChildAdded, update, get, child } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const postsContainer = document.getElementById("postsContainer");
const postInput = document.getElementById("postInput");
const publishBtn = document.getElementById("publishBtn");
const logoutBtn = document.getElementById("logoutBtn");

const currentUserPhone = localStorage.getItem("currentUser");
if(!currentUserPhone) window.location.href = "index.html";

logoutBtn.onclick = () => { localStorage.removeItem("currentUser"); window.location.href="index.html"; };

publishBtn.onclick = async () => {
  const content = postInput.value.trim();
  if(!content) return alert("المنشور فارغ");
  const post = { content, user: currentUserPhone, likes:0, shares:0, views:0, comments:{} };
  await push(ref(db,'posts'), post);
  postInput.value='';
};

function createPostElement(postId, postData){
  const postDiv = document.createElement('div');
  postDiv.className = 'post';
  postDiv.innerHTML = `
    <strong>${postData.user}</strong>: ${postData.content}<br>
    <button class="likeBtn">إعجاب (${postData.likes})</button>
    <button class="shareBtn">مشاركة (${postData.shares})</button>
    <button class="viewBtn" disabled>مشاهدات (${postData.views})</button>
    <button class="commentBtn">تعليقات (${postData.comments ? Object.keys(postData.comments).length : 0})</button>
    <div class="commentContainer">
      <input type="text" placeholder="أضف تعليق...">
      <button class="addCommentBtn">تعليق</button>
      <div class="commentsList"></div>
    </div>
  `;

  const likeBtn = postDiv.querySelector(".likeBtn");
  const shareBtn = postDiv.querySelector(".shareBtn");
  const viewBtn = postDiv.querySelector(".viewBtn");
  const commentBtn = postDiv.querySelector(".commentBtn");
  const commentContainer = postDiv.querySelector(".commentContainer");
  const addCommentBtn = postDiv.querySelector(".addCommentBtn");
  const commentInput = commentContainer.querySelector("input");
  const commentsList = postDiv.querySelector(".commentsList");

  likeBtn.onclick = () => {
    postData.likes = (postData.likes || 0)+1;
    update(ref(db,'posts/'+postId), { likes: postData.likes });
    likeBtn.textContent = `إعجاب (${postData.likes})`;
  };

  shareBtn.onclick = () => {
    postData.shares = (postData.shares || 0)+1;
    update(ref(db,'posts/'+postId), { shares: postData.shares });
    shareBtn.textContent = `مشاركة (${postData.shares})`;
    alert("تم نسخ رابط المشاركة! (محاكاة)");
  };

  // مشاهدات عند الظهور
  const observer = new IntersectionObserver((entries, obs) => {
    entries.forEach(entry => {
      if(entry.isIntersecting){
        postData.views = (postData.views || 0)+1;
        update(ref(db,'posts/'+postId), { views: postData.views });
        viewBtn.textContent = `مشاهدات (${postData.views})`;
        obs.unobserve(postDiv);
      }
    });
  }, {threshold:0.5});
  observer.observe(postDiv);

  // التعليقات
  commentBtn.onclick = () => { commentContainer.style.display = commentContainer.style.display==='flex'?'none':'flex'; }
  addCommentBtn.onclick = async () => {
    const text = commentInput.value.trim();
    if(!text) return;
    const commentRef = push(ref(db,'posts/'+postId+'/comments'));
    await commentRef.set({ user: currentUserPhone, text });
    commentInput.value='';
  };

  // تحميل التعليقات
  const commentsRef = ref(db,'posts/'+postId+'/comments');
  onChildAdded(commentsRef, snapshot => {
    const c = snapshot.val();
    const div = document.createElement("div");
    div.textContent = `${c.user}: ${c.text}`;
    commentsList.appendChild(div);
    commentBtn.textContent = `تعليقات (${commentsList.childElementCount})`;
  });

  postsContainer.prepend(postDiv);
}

// جلب كل المنشورات من Firebase
const postsRef = ref(db,'posts');
onChildAdded(postsRef, snapshot => createPostElement(snapshot.key, snapshot.val()));
</script>

</body>
</html>
