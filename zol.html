<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZOL</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo&display=swap" rel="stylesheet">

<style>
body { font-family:'Cairo', sans-serif; margin:0; background:#f4f6f8; }
header { background:#6C63FF; color:#fff; padding:20px 40px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 4px 6px rgba(0,0,0,0.1);}
header h1 { margin:0; font-size:28px; }
header button { padding:10px 20px; font-size:16px; background:#fff; color:#6C63FF; border:none; border-radius:8px; cursor:pointer; transition:.3s; }
header button:hover { background:#3A3D98; color:#fff; }
main { padding:20px; min-height:calc(100vh - 80px); }
.post { background:#fff; margin-bottom:15px; padding:15px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
.post h3 { margin:0 0 5px 0; }
.post p { margin:5px 0; }
.post small { color:gray; }
.post button { margin-left:5px; padding:5px 10px; font-size:12px; border:none; border-radius:5px; cursor:pointer; }
.post .edit-btn { background:#f0ad4e; color:#fff; }
.post .delete-btn { background:#d9534f; color:#fff; }

#addPostBtn { position:fixed; bottom:30px; right:30px; width:60px; height:60px; background:#6C63FF; color:#fff; border:none; border-radius:50%; font-size:36px; cursor:pointer; display:flex; justify-content:center; align-items:center; box-shadow:0 4px 8px rgba(0,0,0,0.2); transition:.3s; }
#addPostBtn:hover { background:#3A3D98; }

#postModal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
#postModal .modal-content { background:#fff; padding:20px; border-radius:10px; width:300px; }
#postModal input, #postModal textarea { width:100%; margin-bottom:10px; padding:10px; border-radius:5px; border:1px solid #ccc; outline:none; }
#postModal button { width:100%; padding:10px; background:#6C63FF; color:#fff; border:none; border-radius:5px; cursor:pointer; }
#postModal button:hover { background:#3A3D98; }

.comments { margin-top:10px; border-top:1px solid #eee; padding-top:10px; }
.comment { background:#f1f1f1; padding:5px 10px; margin-bottom:5px; border-radius:5px; }
.comment small { color:gray; }
.comment-input { display:flex; margin-top:5px; }
.comment-input input { flex:1; padding:5px 10px; border-radius:5px; border:1px solid #ccc; }
.comment-input button { padding:5px 10px; margin-left:5px; background:#6C63FF; color:#fff; border:none; border-radius:5px; cursor:pointer; }
</style>
</head>

<body>

<header>
  <h1>ZOL</h1>
  <button id="logoutBtn">تسجيل الخروج</button>
</header>

<main id="postsContainer"></main>
<button id="addPostBtn">+</button>

<div id="postModal">
  <div class="modal-content">
    <h3>إضافة منشور</h3>
    <input type="text" id="postTitle" placeholder="اسم المنشور">
    <textarea id="postDesc" placeholder="الوصف" rows="4"></textarea>
    <button id="publishBtn">نشر</button>
  </div>
</div>

<script type="module">

/* ========== Firebase SDK ========== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { 
  getDatabase, ref, set, push, onValue, update, remove, get 
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

/* ========== Firebase Config ========== */
const firebaseConfig = {
  apiKey: "AIzaSyDVYoWats4bhKLbO8cu9hQ73WBjty-e5mA",
  authDomain: "aljj-28d36.firebaseapp.com",
  databaseURL: "https://aljj-28d36-default-rtdb.firebaseio.com",
  projectId: "aljj-28d36",
  storageBucket: "aljj-28d36.firebasestorage.app",
  messagingSenderId: "256012982420",
  appId: "1:256012982420:web:3a1541af04b99d658e7c81",
  measurementId: "G-43WH1GKJFC"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ========== تسجيل الخروج ========== */
const currentUser = JSON.parse(localStorage.getItem("loggedInUser"));
if (!currentUser) window.location.href = "index.html";

document.getElementById("logoutBtn").onclick = () => {
  localStorage.removeItem("loggedInUser");
  window.location.href = "index.html";
};

/* ========== عناصر الصفحة ========== */
const postsContainer = document.getElementById("postsContainer");
const addPostBtn = document.getElementById("addPostBtn");
const postModal = document.getElementById("postModal");
const publishBtn = document.getElementById("publishBtn");
const postTitle = document.getElementById("postTitle");
const postDesc = document.getElementById("postDesc");

/* ========== فتح نافذة إضافة منشور ========== */
addPostBtn.onclick = () => postModal.style.display = "flex";
postModal.onclick = (e) => { if (e.target === postModal) postModal.style.display = "none"; };

/* ========== نشر منشور ========== */
publishBtn.onclick = async () => {
  const title = postTitle.value.trim();
  const desc = postDesc.value.trim();

  if (!title || !desc) return alert("يرجى إدخال جميع الحقول");

  try {
    const newPostRef = push(ref(db, "posts"));

    await set(newPostRef, {
      title,
      desc,
      authorName: currentUser.name,
      authorPhone: currentUser.phone,
      views: 0,
      likes: 0,
      timestamp: Date.now()
    });

    alert("✔ تم نشر المنشور بنجاح");
    postModal.style.display = "none";
    postTitle.value = "";
    postDesc.value = "";

  } catch (err) {
    console.error(err);
    alert("❌ فشل النشر، تحقق من الاتصال بقاعدة البيانات");
  }
};

/* ========== عرض المنشورات ========== */
function addPostToDOM(id, post) {
  const div = document.createElement("div");
  div.className = "post";

  div.innerHTML = `
    <h3>${post.title}</h3>
    <p>${post.desc}</p>
    <small>الكاتب: ${post.authorName} | المشاهدات: ${post.views}</small>
    <div style="margin-top:5px;">
      <button class="like-btn">♥</button> <span class="likes-count">${post.likes}</span>
    </div>
    <div class="comments" id="comments-${id}"></div>
  `;

  /* تعديل وحذف */
  if (post.authorPhone === currentUser.phone) {
    const editBtn = document.createElement("button");
    editBtn.className = "edit-btn";
    editBtn.textContent = "تعديل";

    editBtn.onclick = async () => {
      const newTitle = prompt("العنوان:", post.title);
      const newDesc = prompt("الوصف:", post.desc);
      if (newTitle && newDesc) {
        await update(ref(db, "posts/" + id), { title: newTitle, desc: newDesc });
      }
    };

    const deleteBtn = document.createElement("button");
    deleteBtn.className = "delete-btn";
    deleteBtn.textContent = "حذف";
    deleteBtn.onclick = () => remove(ref(db, "posts/" + id));

    div.appendChild(editBtn);
    div.appendChild(deleteBtn);
  }

  /* زر اللايك */
  const likeBtn = div.querySelector(".like-btn");
  const likesCount = div.querySelector(".likes-count");
  const postRef = ref(db, "posts/" + id);

  likeBtn.onclick = async () => {
    const userLikeRef = ref(db, "likes/" + id + "/" + currentUser.phone);
    const snap = await get(userLikeRef);

    if (snap.exists()) return; // لايك واحد فقط

    await set(userLikeRef, true);

    const p = (await get(postRef)).val();
    await update(postRef, { likes: (p.likes || 0) + 1 });
  };

  /* التعليقات */
  const commentsContainer = div.querySelector(".comments");

  const inputDiv = document.createElement("div");
  inputDiv.className = "comment-input";
  inputDiv.innerHTML = `
    <input type="text" placeholder="أضف تعليقك">
    <button>نشر</button>
  `;

  const cInput = inputDiv.querySelector("input");
  const cBtn = inputDiv.querySelector("button");

  cBtn.onclick = () => {
    const text = cInput.value.trim();
    if (!text) return;

    const newCommentRef = push(ref(db, "comments/" + id));
    set(newCommentRef, {
      text,
      authorName: currentUser.name,
      authorPhone: currentUser.phone,
      timestamp: Date.now()
    });

    cInput.value = "";
  };

  div.appendChild(inputDiv);

  const commentsRef = ref(db, "comments/" + id);
  onValue(commentsRef, snap => {
    commentsContainer.innerHTML = "";
    const data = snap.val();
    if (!data) return;

    Object.values(data).forEach(c => {
      const cDiv = document.createElement("div");
      cDiv.className = "comment";
      cDiv.innerHTML = `<small>${c.authorName}</small>: ${c.text}`;
      commentsContainer.appendChild(cDiv);
    });
  });

  postsContainer.prepend(div);
}

/* ========== جلب المنشورات ========== */
const postsRef = ref(db, "posts");
onValue(postsRef, snapshot => {
  postsContainer.innerHTML = "";
  const data = snapshot.val();
  if (!data) return;

  Object.entries(data)
    .sort((a, b) => b[1].timestamp - a[1].timestamp)
    .forEach(([id, post]) => addPostToDOM(id, post));
});

</script>

</body>
</html>
