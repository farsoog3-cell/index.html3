<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZOL</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo&display=swap" rel="stylesheet">
<style>
body { font-family:'Cairo', sans-serif; margin:0; background:#f4f6f8; }
header { background:#6C63FF; color:#fff; padding:20px 40px; display:flex; justify-content:space-between; align-items:center; }
header h1 { margin:0; font-size:28px; }
header button { padding:10px 20px; background:#fff; color:#6C63FF; border:none; border-radius:8px; cursor:pointer; font-weight:bold; }
main { padding:20px; }
.post { background:#fff; margin-bottom:15px; padding:15px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
.post h3 { margin:0 0 5px 0; }
.post small { color:gray; }
.post button { margin-top:8px; padding:5px 10px; border:none; border-radius:5px; cursor:pointer; font-size:14px; }
.edit-btn { background:#f0ad4e; color:#fff; }
.delete-btn { background:#d9534f; color:#fff; }
.like-btn { background:#6C63FF; color:#fff; }
#addPostBtn { position:fixed; bottom:20px; right:20px; width:60px; height:60px; background:#6C63FF; color:#fff; border:none; border-radius:50%; font-size:36px; cursor:pointer; }
#postModal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
#postModal .modal-content { background:#fff; padding:20px; border-radius:10px; width:300px; }
#postModal input, #postModal textarea { width:100%; padding:10px; margin-bottom:10px; border-radius:5px; border:1px solid #ccc; }
.comments { margin-top:10px; border-top:1px solid #eee; padding-top:10px; }
.comment { background:#eee; padding:8px; border-radius:5px; margin-bottom:5px; }
.comment-input { display:flex; margin-top:10px; }
.comment-input input { flex:1; padding:8px; border-radius:5px; border:1px solid #ccc; }
.comment-input button { padding:8px 12px; margin-left:5px; background:#6C63FF; color:#fff; border:none; border-radius:5px; cursor:pointer; }
</style>
</head>
<body>

<header>
  <h1>ZOL</h1>
  <button id="logoutBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</header>

<main id="postsContainer"></main>
<button id="addPostBtn">+</button>

<div id="postModal">
  <div class="modal-content">
    <h3>Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø´ÙˆØ±</h3>
    <input type="text" id="postTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†Ø´ÙˆØ±">
    <textarea id="postDesc" placeholder="Ø§Ù„Ù…Ø­ØªÙˆÙ‰" rows="4"></textarea>
    <button id="publishBtn">Ù†Ø´Ø±</button>
  </div>
</div>

<script type="module">

/* ============ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Firebase ============ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, set, push, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

/* ============ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ============ */
const firebaseConfig = {
  apiKey: "AIzaSyDVYoWats4bhKLbO8cu9hQ73WBjty-e5mA",
  authDomain: "aljj-28d36.firebaseapp.com",
  databaseURL: "https://aljj-28d36-default-rtdb.firebaseio.com",
  projectId: "aljj-28d36",
  storageBucket: "aljj-28d36.firebasestorage.app",
  messagingSenderId: "256012982420",
  appId: "1:256012982420:web:3a1541af04b99d658e7c81",
  measurementId: "G-43WH1GKJFC"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ============ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ============ */
const currentUser = JSON.parse(localStorage.getItem("loggedInUser"));
if (!currentUser) window.location.href = "index.html";

/* ============ Ø¹Ù†Ø§ØµØ± DOM ============ */
const postsContainer = document.getElementById("postsContainer");
const addPostBtn = document.getElementById("addPostBtn");
const postModal = document.getElementById("postModal");
const publishBtn = document.getElementById("publishBtn");
const postTitle = document.getElementById("postTitle");
const postDesc = document.getElementById("postDesc");
const logoutBtn = document.getElementById("logoutBtn");

/* ============ ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ============ */
logoutBtn.onclick = () => {
  localStorage.removeItem("loggedInUser");
  window.location.href = "index.html";
};

/* ============ ÙØªØ­ ÙˆØºÙ„Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù†Ø´Ø± ============ */
addPostBtn.onclick = () => postModal.style.display = "flex";
postModal.onclick = (e) => { if (e.target === postModal) postModal.style.display = "none"; };

/* ============ Ù†Ø´Ø± Ù…Ù†Ø´ÙˆØ± ============ */
publishBtn.onclick = async () => {
  const title = postTitle.value.trim();
  const desc = postDesc.value.trim();
  if (!title || !desc) return alert("Ø§Ù…Ù„Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");

  try {
    const newPostRef = push(ref(db, "posts"));

    await set(newPostRef, {
      title,
      desc,
      authorName: currentUser.name,
      authorPhone: currentUser.phone,
      views: 0,
      likes: 0,
      timestamp: Date.now()
    });

    postTitle.value = "";
    postDesc.value = "";
    postModal.style.display = "none";

    alert("âœ” ØªÙ… Ù†Ø´Ø± Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­!");

  } catch (err) {
    alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
  }
};

/* ============ Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø´ÙˆØ± Ù„ØµÙØ­Ø© Ø§Ù„Ø¹Ø±Ø¶ ============ */
function addPostToDOM(postId, post) {

  const div = document.createElement("div");
  div.classList.add("post");

  div.innerHTML = `
    <h3>${post.title}</h3>
    <p>${post.desc}</p>
    <small>Ø§Ù„ÙƒØ§ØªØ¨: ${post.authorName} | ğŸ‘ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª: ${post.views}</small>

    <button class="like-btn">â™¥ Ø¥Ø¹Ø¬Ø§Ø¨</button> 
    <span class="likes-count">${post.likes}</span>

    <div class="comments" id="comments-${postId}"></div>
  `;

  /* ============ ØªØ¹Ø¯ÙŠÙ„ / Ø­Ø°Ù Ù„Ù„Ù…Ø§Ù„Ùƒ ============ */
  if (post.authorPhone === currentUser.phone) {

    const editBtn = document.createElement("button");
    editBtn.classList.add("edit-btn");
    editBtn.textContent = "ØªØ¹Ø¯ÙŠÙ„";

    editBtn.onclick = async () => {
      const t = prompt("Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯:", post.title);
      const d = prompt("Ø§Ù„ÙˆØµÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯:", post.desc);
      if (t && d) await update(ref(db, "posts/" + postId), { title: t, desc: d });
    };

    const deleteBtn = document.createElement("button");
    deleteBtn.classList.add("delete-btn");
    deleteBtn.textContent = "Ø­Ø°Ù";
    deleteBtn.onclick = () => remove(ref(db, "posts/" + postId));

    div.appendChild(editBtn);
    div.appendChild(deleteBtn);
  }

  /* ============ Ù„Ø§ÙŠÙƒ Ù…Ø­Ù…ÙŠ ============ */
  const likeBtn = div.querySelector(".like-btn");
  const likesCount = div.querySelector(".likes-count");
  const postRef = ref(db, "posts/" + postId);

  likeBtn.onclick = async () => {
    const userLikeRef = ref(db, "likes/" + postId + "/" + currentUser.phone);
    const likeSnap = await get(userLikeRef);
    if (likeSnap.exists()) return;

    await set(userLikeRef, true);

    const postSnap = await get(postRef);
    await update(postRef, { likes: (postSnap.val().likes || 0) + 1 });
  };

  /* ============ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ============ */
  const commentsContainer = div.querySelector(".comments");

  const commentInput = document.createElement("div");
  commentInput.classList.add("comment-input");

  commentInput.innerHTML = `
    <input placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ø§Ù‹">
    <button>Ù†Ø´Ø±</button>
  `;

  const input = commentInput.querySelector("input");
  const btn = commentInput.querySelector("button");

  btn.onclick = () => {
    if (!input.value.trim()) return;
    const newC = push(ref(db, "comments/" + postId));
    set(newC, {
      text: input.value,
      authorName: currentUser.name,
      timestamp: Date.now()
    });
    input.value = "";
  };

  div.appendChild(commentInput);

  /* ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª */
  const commentsRef = ref(db, "comments/" + postId);
  onValue(commentsRef, snap => {
    commentsContainer.innerHTML = "";
    const data = snap.val();
    if (!data) return;

    Object.values(data).forEach(c => {
      const cDiv = document.createElement("div");
      cDiv.classList.add("comment");
      cDiv.innerHTML = `<b>${c.authorName}:</b> ${c.text}`;
      commentsContainer.appendChild(cDiv);
    });
  });

  /* ============ Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª ============ */
  update(postRef, { views: post.views + 1 });

  postsContainer.prepend(div);
}

/* ============ ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª ============ */
const postsRef = ref(db, "posts");

onValue(postsRef, snap => {
  postsContainer.innerHTML = "";
  const data = snap.val();
  if (!data) return;

  Object.entries(data)
    .sort((a, b) => b[1].timestamp - a[1].timestamp)
    .forEach(([id, p]) => addPostToDOM(id, p));
});

</script>

</body>
</html>
